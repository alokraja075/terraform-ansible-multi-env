---
- name: Bootstrap EC2 instances
  hosts: ec2_instances
  gather_facts: no
  vars:
    ansible_python_interpreter: /usr/bin/python3

  tasks:
    - name: Wait for system to be ready
      raw: sleep 5

    - name: Update apt cache
      raw: sudo apt-get update -y
      register: apt_update
      until: apt_update is succeeded
      retries: 3
      delay: 10

    - name: Upgrade Python to 3.10+
      raw: |
        sudo apt-get install -y python3.10 python3-apt
        sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.10 1
      register: python_upgrade
      until: python_upgrade is succeeded
      retries: 3
      delay: 10

    - name: Gather facts
      setup:
