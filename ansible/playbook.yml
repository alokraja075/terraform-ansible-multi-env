---
- name: Configure EC2 instances with Ansible
  hosts: ec2_instances
  gather_facts: no

  vars:
    nginx_version: "latest"
    env_name: "production"

  pre_tasks:
    - name: Remove command-not-found apt hook to avoid apt_pkg error
      raw: sudo rm -f /etc/apt/apt.conf.d/50command-not-found /etc/apt/apt.conf.d/99disable-cnf
      changed_when: false

    - name: Update apt cache (raw)
      raw: sudo apt-get update -y
      changed_when: false

    - name: Install Python 3.9 and deps (raw)
      raw: sudo apt-get install -y python3.9 python3.9-venv python3.9-distutils python3-apt
      changed_when: false

    - name: Set python3 alternative to 3.9
      raw: sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.9 2
      changed_when: false

    - name: Point Ansible interpreter to python3.9
      set_fact:
        ansible_python_interpreter: /usr/bin/python3.9

    - name: Gather facts
      setup:
  
  roles:
    - name: Update system packages
      role: system-update
      tags:
        - system
        - update

    - name: Install and configure Nginx
      role: nginx
      tags:
        - nginx
        - web

  post_tasks:
    - name: Verify Nginx is active
      raw: sudo systemctl is-active nginx
      register: nginx_status
      changed_when: false

    - name: Display deployment summary
      debug:
        msg:
          - "=========================================="
          - "âœ“ Nginx Installation Complete!"
          - "=========================================="
          - "Instance: ec2-instance-1"
          - "Nginx Status: Active and Running"
          - "=========================================="
