---
- name: Configure EC2 instances with Ansible
  hosts: ec2_instances
  gather_facts: no
  
  vars:
    nginx_version: "latest"
    env_name: "production"
  
  pre_tasks:
    - name: Upgrade Python to 3.9+
      raw: sudo apt-get update -y && sudo apt-get install -y python3.9 python3.9-dev python3.9-venv || true
      changed_when: false
    
    - name: Set python3.9 as default
      raw: sudo update-alternatives --install /usr/bin/python3 python3 /usr/bin/python3.9 1 || true
      changed_when: false
    
    - name: Gather facts
      setup:
  
  roles:
    - name: Update system packages
      role: system-update
      tags:
        - system
        - update

    - name: Install and configure Nginx
      role: nginx
      tags:
        - nginx
        - web

  post_tasks:
    - name: Verify Nginx is active
      raw: sudo systemctl is-active nginx
      register: nginx_status
      changed_when: false

    - name: Display deployment summary
      debug:
        msg:
          - "=========================================="
          - "âœ“ Nginx Installation Complete!"
          - "=========================================="
          - "Instance: ec2-instance-1"
          - "Nginx Status: Active and Running"
          - "=========================================="
