- name: Configure EC2 instances with Ansible
  hosts: ec2_instances
  become: no
  gather_facts: no
  
  vars:
    nginx_version: "latest"
    env_name: "production"
  
  pre_tasks:
    - name: Wait for SSH to be ready
      wait_for_connection:
        timeout: 120
      become: false

    - name: Install Python3 if needed
      raw: sudo apt-get update -y && sudo apt-get install -y python3-minimal
      changed_when: false
      ignore_errors: yes
    
    - name: Gather facts
      setup:
      become: false
  
  roles:
    - name: Update system packages
      role: system-update
      tags:
        - system
        - update

    - name: Install and configure Nginx
      role: nginx
      tags:
        - nginx
        - web

  post_tasks:
    - name: Verify Nginx is active
      raw: sudo systemctl is-active nginx
      register: nginx_status
      changed_when: false

    - name: Display deployment summary
      debug:
        msg:
          - "=========================================="
          - "âœ“ Nginx Installation Complete!"
          - "=========================================="
          - "Instance: ec2-instance-1"
          - "Nginx Status: Active and Running"
          - "=========================================="
