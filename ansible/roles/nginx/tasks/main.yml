---
- name: Install and configure Nginx
  block:
    - name: Install Nginx package
      apt:
        name: nginx
        state: present
        update_cache: yes
        cache_valid_time: 3600
      become: yes

    - name: Ensure web root exists
      file:
        path: /var/www/html
        state: directory
        owner: www-data
        group: www-data
        mode: "0755"
      become: yes

    - name: Deploy Nginx default site
      template:
        src: nginx.conf.j2
        dest: /etc/nginx/sites-available/default
        owner: root
        group: root
        mode: "0644"
      notify: Reload Nginx
      become: yes

    - name: Deploy landing page
      template:
        src: index.html.j2
        dest: /var/www/html/index.html
        owner: www-data
        group: www-data
        mode: "0644"
      become: yes

    - name: Validate Nginx configuration
      command: nginx -t
      register: nginx_config_test
      changed_when: false
      failed_when: nginx_config_test.rc != 0
      become: yes

    - name: Ensure Nginx service is enabled and running
      systemd:
        name: nginx
        state: started
        enabled: yes
      become: yes

    - name: Capture Nginx version
      command: nginx -v
      register: nginx_version_cmd
      changed_when: false
      failed_when: false
      become: yes

    - name: Set Nginx version fact
      set_fact:
        nginx_version: "{{ nginx_version_cmd.stderr | regex_search('nginx/([0-9.]+)', '\\1') | default('unknown') }}"
      when: nginx_version_cmd is defined

    - name: Display Nginx status
      debug:
        msg:
          - "Nginx config test: {{ nginx_config_test.rc == 0 | ternary('ok', 'failed') }}"
          - "Nginx version: {{ nginx_version | default('unknown') }}"
