---
- name: Install and configure Nginx
  block:
    - name: Disable command-not-found apt hook (missing apt_pkg workaround)
      copy:
        dest: /etc/apt/apt.conf.d/99disable-cnf
        content: |
          DPkg::Post-Invoke { "if false; then /usr/lib/cnf-update-db; fi"; };
          APT::Update::Post-Invoke-Success { "if false; then /usr/lib/cnf-update-db; fi"; };
        owner: root
        group: root
        mode: "0644"
      become: yes

    - name: Install Nginx package (apt-get fallback to avoid python-apt)
      shell: sudo apt-get install -y nginx
      register: nginx_install
      changed_when: "'Setting up nginx' in nginx_install.stdout or 'Preparing to unpack' in nginx_install.stdout"
      failed_when: nginx_install.rc != 0
      become: yes

    - name: Ensure web root exists
      file:
        path: /var/www/html
        state: directory
        owner: www-data
        group: www-data
        mode: "0755"
      become: yes

    - name: Deploy Nginx default site
      template:
        src: nginx.conf.j2
        dest: /etc/nginx/sites-available/default
        owner: root
        group: root
        mode: "0644"
      notify: Reload Nginx
      become: yes

    - name: Deploy landing page
      template:
        src: index.html.j2
        dest: /var/www/html/index.html
        owner: www-data
        group: www-data
        mode: "0644"
      become: yes

    - name: Validate Nginx configuration
      command: nginx -t
      register: nginx_config_test
      changed_when: false
      failed_when: nginx_config_test.rc != 0
      become: yes

    - name: Ensure Nginx service is enabled and running
      systemd:
        name: nginx
        state: started
        enabled: yes
      become: yes

    - name: Capture Nginx version
      command: nginx -v
      register: nginx_version_cmd
      changed_when: false
      failed_when: false
      become: yes

    - name: Set Nginx version fact
      set_fact:
        nginx_version: "{{ nginx_version_cmd.stderr | regex_search('nginx/([0-9.]+)', '\\1') | default('unknown') }}"
      when: nginx_version_cmd is defined

    - name: Display Nginx status
      debug:
        msg:
          - "Nginx config test: {{ nginx_config_test.rc == 0 | ternary('ok', 'failed') }}"
          - "Nginx version: {{ nginx_version | default('unknown') }}"
